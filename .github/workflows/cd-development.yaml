name: CD - FrontWeb - Development Environment
on:
  workflow_call:
    inputs:
      mode:
        required: true
        type: string
        description: "Deployment build mode (e.g., 'development', 'staging', 'production')"
    secrets:
      UAT_REMOTE_SSH_KEY:
        required: true
      UAT_REMOTE_HOST:
        required: true
      UAT_REMOTE_USER:
        required: true
      TELEGRAM_BOT_TOKEN:
        required: true
      TELEGRAM_CHAT_ID:
        required: true
jobs:
  "build-deploy":
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Cache pnpm modules
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store # ç¼“å­˜ pnpm çš„ä¾èµ–
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }} # åŸºäº pnpm-lock.yaml æ–‡ä»¶å“ˆå¸Œç”Ÿæˆç¼“å­˜é”®
          restore-keys: |
            ${{ runner.os }}-pnpm-
      - name: Install PNPM 10
        uses: pnpm/action-setup@v4
        with:
          version: 10
      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm" # å¯ç”¨ pnpm ç¼“å­˜
      # ------------------------------
      #  å®‰è£…ä¾èµ–ï¼ˆä¸¥æ ¼æ¨¡å¼ï¼‰
      # ------------------------------
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      # ------------------------------
      # ç”Ÿäº§æ„å»ºï¼ˆå¯¹é½ package.json è„šæœ¬ï¼‰
      # ------------------------------
      - name: "Build with Vite (mode: ${{ inputs.mode }})"
        run: |
          echo "ğŸš§ Building with mode: ${{ inputs.mode }}"
          pnpm run build -- --mode ${{ inputs.mode }}
      # ------------------------------
      # æ„å»ºäº§ç‰©éªŒè¯
      # ------------------------------
      - name: Verify build
        run: |
          [ -f dist/index.html ] || { echo "âŒ Missing index.html"; exit 1; }
          echo "âœ… Build validated"
      # >>>>  ssh deploy start >>>>
      - name: Upload to Deploy Server
        uses: easingthemes/ssh-deploy@v5.1.0
        with:
          SSH_PRIVATE_KEY: ${{ secrets.UAT_REMOTE_SSH_KEY }}
          ARGS: "-rltgoDzvOc --delete"
          SOURCE: "dist/"
          REMOTE_HOST: ${{ secrets.UAT_REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.UAT_REMOTE_USER }}
          TARGET: "/var/www/web/"
          EXCLUDE: "/dist/, /node_modules/"
      # <<<<  ssh deploy end <<<<
      - name: Get commit message
        id: get_commit_message
        run: echo "LATEST_COMMIT_MESSAGE=$(git log -1 --pretty=%B)" >> $GITHUB_OUTPUT
      - name: Send Telegram Notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          GITHUB_WORKFLOW: ${{ github.workflow }} # CI å·¥ä½œæµåç§°
          GITHUB_REF: ${{ github.ref }} # è§¦å‘ CI çš„ Git åˆ†æ”¯
          GITHUB_SHA: ${{ github.sha }} # å½“å‰æäº¤çš„ Git SHA
          GITHUB_ACTOR: ${{ github.actor }} # è§¦å‘ CI çš„ç”¨æˆ·
          GITHUB_RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }} # è¿è¡Œè¯¦æƒ…é“¾æ¥
          JOB_STATUS: ${{ job.status || 'unknown' }} # ä»»åŠ¡çŠ¶æ€ï¼ˆæˆåŠŸ/å¤±è´¥ï¼‰
          LATEST_COMMIT_MESSAGE: ${{ steps.get_commit_message.outputs.LATEST_COMMIT_MESSAGE }}
        run: |
          curl --location "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
          --form "chat_id=${TELEGRAM_CHAT_ID}" \
          --form "parse_mode=Markdown" \
          --form "text=ğŸ“¢ *GitHub ä½œä¸šé€šçŸ¥*  ğŸ”¨ *å·¥ä½œæµ:* ${GITHUB_WORKFLOW} ğŸ”— *ä½œä¸šåœ°å€:* ${GITHUB_RUN_URL} ğŸ“¦ *åˆ†æ”¯:* ${GITHUB_REF} Commit: `${GITHUB_SHA}`  ğŸ‘¤ *è§¦å‘è€…:* ${GITHUB_ACTOR}  ğŸ“ *æäº¤æ¶ˆæ¯:* ${LATEST_COMMIT_MESSAGE}  ğŸš¦ *çŠ¶æ€:* ${JOB_STATUS}"
